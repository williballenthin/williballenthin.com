---
title: "Learning miasm: Part 2: Analyzing instructions"
date: 2020-01-12T14:05:23-07:00
draft: false
---

Once we've used [miasm](https://github.com/cea-sec/miasm) to
 [load data into a container](http://www.williballenthin.com/post/2020-01-09-miasm-part-1/),
 then its time to disassemble instructions.
I've found that there are two useful modes of disassembling:

  1. parse a few bytes into an instruction instance, or
  2. parse many bytes, analyze the instructions, and recover a Control Flow Graph (CFG).

The first approach is useful when dealing with very small snippets, while
the second is better when reasoning about sequences of instructions.
If you're picturing your algorithm in terms of IDA's graph view, then you'll want to reach for the CFG technique.

## Disassembling single instructions

You can use miasm's disassembler object to parse bytes into an instruction.
Note that only the first instruction is parsed.

```python
buf = b'\xB8\x01\x00\x00\x00\x90\x90\x90\x90'
container = miasm.analysis.binary.Container.from_string(buf)
machine = miasm.analysis.machine.Machine('x86_32')  # use container.arch when inspecting PE/ELF/etc.
disassembler = machine.dis_engine(container.bin_stream, follow_call=True)
insn = disassembler.dis_instr(offset=0x0)

print(insn)
>>> <miasm.arch.x86.arch.instruction_x86 at 0x7fbaa250f2e8>

print(str(insn))
>>> 'MOV        EAX, 0x1'
```

The mnemonic is accessible as `name` and the operands are called `args`.
The length of the instruction is available as a property called `l`.

```python
assert insn.l == 5

assert insn.name == 'MOV'

print(insn.args)
>>> [ExprId('EAX', 32), ExprInt(0x1, 32)]
```

An operand instance has some helpful accessors to help you determine the type and value:

```python
arg0 = insn.args[0]
arg1 = insn.args[1]

print(arg0)
>>> ExprId('EAX', 32)

assert arg0.is_id() == True
assert arg0.is_int() == False
assert arg0.is_mem() == False
assert arg0.is_loc() == False
assert arg0.name == 'EAX'

print(arg1)
>>> ExprInt(0x1, 32)

assert arg1.is_id() == False
assert arg1.is_int() == True
assert arg1.is_mem() == False
assert arg1.is_loc() == False
assert arg1.arg == miasm.expression.modint.uint32(0x1)
```


## Disassembling multiple instructions

Most of the time, I deal with long sequences of instructions.
For these, I've found miasm's CFG analysis more useful because it helps me understand the dependencies among instructions.
In this mode, miasm parses many instructions that it groups by basic block.
Miasm follows control flow instructions, such as `jmp` or `call`, and records links among the basic blocks.

The result of this operation is an `AsmCFG` instance, which stands for "AsSeMbly Control Flow Graph"
(miasm also has `IrCFG` and `IraCFG` objects for reasoning about intermediate representations, too).
This object provides accessors for the recovered basic blocks and their control flow edges.
Within a basic block, you can enumerate the instruction instances and inspect them as shown in the first section.


#### Sidebar: rendering CFGs

While unlikely to be useful to large scale analysis, miasm can render `AsmCFG` instances to Graphviz Dot format.
This is how I'll demonstrate examples. An empty CFG has an empty image, of course:

```python
import graphviz
cfg = miasm.core.asmblock.AsmCFG()
graphviz.Source(cfg.dot())
```

The output (empty):

<div style="border: 1px solid grey; width: 20px">
<svg width="8pt" height="8pt" viewBox="0.00 0.00 8.00 8.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 4)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-4 4,-4 4,4 -4,4"/></g></svg>
</div>

#### back to disassembling...

To demonstrate features of miasm's CFG analysis, let's use the following disassembly snippet:

```assembly
00000000 <A>:
0:  b8 01 00 00 00          mov    eax,0x1
5:  eb 00                   jmp    7 <B>
00000007 <B>:
7:  b8 02 00 00 00          mov    eax,0x2
c:  eb 00                   jmp    e <C>
0000000e <C>:
e:  b8 03 00 00 00          mov    eax,0x3
13: eb f9                   jmp    e <C>
00000015 <D>:
15: b8 04 00 00 00          mov    eax,0x4
1a: eb 00                   jmp    1c <E>
0000001c <E>:
1c: b8 05 00 00 00          mov    eax,0x5
21: eb eb                   jmp    e <C> 
```

These instructions can be broken down into five basic blocks that have labels `A` - `E`.
Basic block `A` flows to `B` flows to `C`, and `D` flows to `E` flows to `C`. 
The two entry points `A` and `D` both eventually flow to `C`.
Basic block `C` flows to itself.
If you were to lay them out in IDA, you might see a `Y` shape:

<svg width="396pt" height="320pt" viewBox="0.00 0.00 396.00 320.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 316)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-316 392,-316 392,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-232.5C12,-232.5 173,-232.5 173,-232.5 179,-232.5 185,-238.5 185,-244.5 185,-244.5 185,-299.5 185,-299.5 185,-305.5 179,-311.5 173,-311.5 173,-311.5 12,-311.5 12,-311.5 6,-311.5 0,-305.5 0,-299.5 0,-299.5 0,-244.5 0,-244.5 0,-238.5 6,-232.5 12,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-284 10.5,-305 175.5,-305 175.5,-284 10.5,-284"/><text text-anchor="start" x="88.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">A</text><text text-anchor="start" x="13.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text><text text-anchor="start" x="13.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;B</text></g><!-- 1 --><g id="node2" class="node"><title>1</title><path fill="none" stroke="#000000" d="M12,-116.5C12,-116.5 173,-116.5 173,-116.5 179,-116.5 185,-122.5 185,-128.5 185,-128.5 185,-183.5 185,-183.5 185,-189.5 179,-195.5 173,-195.5 173,-195.5 12,-195.5 12,-195.5 6,-195.5 0,-189.5 0,-183.5 0,-183.5 0,-128.5 0,-128.5 0,-122.5 6,-116.5 12,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-168 10.5,-189 175.5,-189 175.5,-168 10.5,-168"/><text text-anchor="start" x="88.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">B</text><text text-anchor="start" x="13.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 0&#45;&gt;1 --><g id="edge1" class="edge"><title>0&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M92.5,-232.4038C92.5,-223.9125 92.5,-214.8341 92.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-205.8115 92.5,-195.8116 89.0001,-205.8116 96.0001,-205.8115"/></g><!-- 2 --><g id="node3" class="node"><title>2</title><path fill="none" stroke="#000000" d="M113,-.5C113,-.5 274,-.5 274,-.5 280,-.5 286,-6.5 286,-12.5 286,-12.5 286,-67.5 286,-67.5 286,-73.5 280,-79.5 274,-79.5 274,-79.5 113,-79.5 113,-79.5 107,-79.5 101,-73.5 101,-67.5 101,-67.5 101,-12.5 101,-12.5 101,-6.5 107,-.5 113,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="111.5,-52 111.5,-73 276.5,-73 276.5,-52 111.5,-52"/><text text-anchor="start" x="189.5" y="-58.8" font-family="Courier New" font-size="14.00" fill="#000000">C</text><text text-anchor="start" x="114.5" y="-35.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x3</text><text text-anchor="start" x="114.5" y="-12.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 1&#45;&gt;2 --><g id="edge2" class="edge"><title>1&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M126.976,-116.4038C135.0925,-107.0818 143.8252,-97.0522 152.2076,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="154.9095,-89.6518 158.8365,-79.8116 149.6302,-85.0551 154.9095,-89.6518"/></g><!-- 2&#45;&gt;2 --><g id="edge3" class="edge"><title>2&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M286.2015,-58.2426C296.9847,-54.8758 304,-48.7949 304,-40 304,-34.0909 300.8332,-29.407 295.4845,-25.9482"/><polygon fill="#0000ff" stroke="#0000ff" points="296.7559,-22.6821 286.2015,-21.7574 293.8756,-29.0621 296.7559,-22.6821"/></g><!-- 3 --><g id="node4" class="node"><title>3</title><path fill="none" stroke="#000000" d="M215,-232.5C215,-232.5 376,-232.5 376,-232.5 382,-232.5 388,-238.5 388,-244.5 388,-244.5 388,-299.5 388,-299.5 388,-305.5 382,-311.5 376,-311.5 376,-311.5 215,-311.5 215,-311.5 209,-311.5 203,-305.5 203,-299.5 203,-299.5 203,-244.5 203,-244.5 203,-238.5 209,-232.5 215,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-284 213.5,-305 378.5,-305 378.5,-284 213.5,-284"/><text text-anchor="start" x="291.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">D</text><text text-anchor="start" x="216.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x4</text><text text-anchor="start" x="216.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;E</text></g><!-- 4 --><g id="node5" class="node"><title>4</title><path fill="none" stroke="#000000" d="M215,-116.5C215,-116.5 376,-116.5 376,-116.5 382,-116.5 388,-122.5 388,-128.5 388,-128.5 388,-183.5 388,-183.5 388,-189.5 382,-195.5 376,-195.5 376,-195.5 215,-195.5 215,-195.5 209,-195.5 203,-189.5 203,-183.5 203,-183.5 203,-128.5 203,-128.5 203,-122.5 209,-116.5 215,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-168 213.5,-189 378.5,-189 378.5,-168 213.5,-168"/><text text-anchor="start" x="291.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">E</text><text text-anchor="start" x="216.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x5</text><text text-anchor="start" x="216.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 3&#45;&gt;4 --><g id="edge4" class="edge"><title>3&#45;&gt;4</title><path fill="none" stroke="#0000ff" d="M295.5,-232.4038C295.5,-223.9125 295.5,-214.8341 295.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="299.0001,-205.8115 295.5,-195.8116 292.0001,-205.8116 299.0001,-205.8115"/></g><!-- 4&#45;&gt;2 --><g id="edge5" class="edge"><title>4&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M260.6827,-116.4038C252.4857,-107.0818 243.6666,-97.0522 235.2013,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="237.7385,-85.0101 228.5067,-79.8116 232.4817,-89.6325 237.7385,-85.0101"/></g></g></svg>

We'll load the raw shellcode into a container, select the appropriate architecture, and create a disassembler.
Then, `dis_multiblock` disassembles many instructions, grouping them into basic blocks and control flow edges.

```python
buf = b'\xB8\x01\x00\x00\x00\xEB\x00\xB8\x02\x00\x00\x00\xEB\x00\xB8\x03\x00\x00\x00\xEB\xF9\xB8\x04\x00\x00\x00\xEB\x00\xB8\x05\x00\x00\x00\xEB\xEB'
container = miasm.analysis.binary.Container.from_string(buf)
machine = miasm.analysis.machine.Machine('x86_32')  # use container.arch when inspecting PE/ELF/etc.
disassembler = machine.dis_engine(container.bin_stream, follow_call=True)
cfg = disassembler.dis_multiblock(offset=0x0)
```

This results in the following CFG:

<svg width="211pt" height="320pt" viewBox="0.00 0.00 211.00 320.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 316)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-316 207,-316 207,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-232.5C12,-232.5 173,-232.5 173,-232.5 179,-232.5 185,-238.5 185,-244.5 185,-244.5 185,-299.5 185,-299.5 185,-305.5 179,-311.5 173,-311.5 173,-311.5 12,-311.5 12,-311.5 6,-311.5 0,-305.5 0,-299.5 0,-299.5 0,-244.5 0,-244.5 0,-238.5 6,-232.5 12,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-284 10.5,-305 175.5,-305 175.5,-284 10.5,-284"/><text text-anchor="start" x="72" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">loc_0</text><text text-anchor="start" x="13.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text><text text-anchor="start" x="13.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;loc_7</text></g><!-- 1 --><g id="node2" class="node"><title>1</title><path fill="none" stroke="#000000" d="M12,-116.5C12,-116.5 173,-116.5 173,-116.5 179,-116.5 185,-122.5 185,-128.5 185,-128.5 185,-183.5 185,-183.5 185,-189.5 179,-195.5 173,-195.5 173,-195.5 12,-195.5 12,-195.5 6,-195.5 0,-189.5 0,-183.5 0,-183.5 0,-128.5 0,-128.5 0,-122.5 6,-116.5 12,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-168 10.5,-189 175.5,-189 175.5,-168 10.5,-168"/><text text-anchor="start" x="72" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">loc_7</text><text text-anchor="start" x="13.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;loc_e</text></g><!-- 0&#45;&gt;1 --><g id="edge1" class="edge"><title>0&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M92.5,-232.4038C92.5,-223.9125 92.5,-214.8341 92.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-205.8115 92.5,-195.8116 89.0001,-205.8116 96.0001,-205.8115"/></g><!-- 2 --><g id="node3" class="node"><title>2</title><path fill="none" stroke="#000000" d="M12,-.5C12,-.5 173,-.5 173,-.5 179,-.5 185,-6.5 185,-12.5 185,-12.5 185,-67.5 185,-67.5 185,-73.5 179,-79.5 173,-79.5 173,-79.5 12,-79.5 12,-79.5 6,-79.5 0,-73.5 0,-67.5 0,-67.5 0,-12.5 0,-12.5 0,-6.5 6,-.5 12,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-52 10.5,-73 175.5,-73 175.5,-52 10.5,-52"/><text text-anchor="start" x="72" y="-58.8" font-family="Courier New" font-size="14.00" fill="#000000">loc_e</text><text text-anchor="start" x="13.5" y="-35.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x3</text><text text-anchor="start" x="13.5" y="-12.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;loc_e</text></g><!-- 1&#45;&gt;2 --><g id="edge2" class="edge"><title>1&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M92.5,-116.4038C92.5,-107.9125 92.5,-98.8341 92.5,-90.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-89.8115 92.5,-79.8116 89.0001,-89.8116 96.0001,-89.8115"/></g><!-- 2&#45;&gt;2 --><g id="edge3" class="edge"><title>2&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M185.2015,-58.2426C195.9847,-54.8758 203,-48.7949 203,-40 203,-34.0909 199.8332,-29.407 194.4845,-25.9482"/><polygon fill="#0000ff" stroke="#0000ff" points="195.7559,-22.6821 185.2015,-21.7574 192.8756,-29.0621 195.7559,-22.6821"/></g></g></svg>

Some things to note:

  - miasm started disassembling from address 0x0, which we specified as `offset=0x0` above.
  - miasm did not find basic blocks `D` or `E`, because they are not referenced from the entry point.
  - the disassembly looks consistent with our initial listing, that's good!
  - miasm created its own names for these basic blocks using a reasonable default schema (`loc_` + address).

### Naming locations with LocationDB

Let's start by addressing that final point and teach miasm about our names for these basic blocks.
To do this, we'll use a `LocationDB` to associate names with locations within a container.
I've found that miasm uses the LocationDB heavily to refer to locations in a Container, so you'll quickly get familiar with this abstraction.

```python
container = miasm.analysis.binary.Container.from_string(buf)

loc_db = container.loc_db
loc_db.add_location(offset=0x0, name="A")
loc_db.add_location(offset=0x7, name="B")
loc_db.add_location(offset=0xE, name="C")
loc_db.add_location(offset=0x15, name="D")
loc_db.add_location(offset=0x1C, name="E")

machine = miasm.analysis.machine.Machine('x86_32')  # use container.arch when inspecting PE/ELF/etc.
disassembler = machine.dis_engine(container.bin_stream, loc_db=loc_db, follow_call=True)  # note: added reference to `loc_db`
cfg = disassembler.dis_multiblock(offset=0x0)
```

<svg width="211pt" height="320pt" viewBox="0.00 0.00 211.00 320.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 316)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-316 207,-316 207,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-232.5C12,-232.5 173,-232.5 173,-232.5 179,-232.5 185,-238.5 185,-244.5 185,-244.5 185,-299.5 185,-299.5 185,-305.5 179,-311.5 173,-311.5 173,-311.5 12,-311.5 12,-311.5 6,-311.5 0,-305.5 0,-299.5 0,-299.5 0,-244.5 0,-244.5 0,-238.5 6,-232.5 12,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-284 10.5,-305 175.5,-305 175.5,-284 10.5,-284"/><text text-anchor="start" x="88.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">A</text><text text-anchor="start" x="13.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text><text text-anchor="start" x="13.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;B</text></g><!-- 1 --><g id="node2" class="node"><title>1</title><path fill="none" stroke="#000000" d="M12,-116.5C12,-116.5 173,-116.5 173,-116.5 179,-116.5 185,-122.5 185,-128.5 185,-128.5 185,-183.5 185,-183.5 185,-189.5 179,-195.5 173,-195.5 173,-195.5 12,-195.5 12,-195.5 6,-195.5 0,-189.5 0,-183.5 0,-183.5 0,-128.5 0,-128.5 0,-122.5 6,-116.5 12,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-168 10.5,-189 175.5,-189 175.5,-168 10.5,-168"/><text text-anchor="start" x="88.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">B</text><text text-anchor="start" x="13.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 0&#45;&gt;1 --><g id="edge1" class="edge"><title>0&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M92.5,-232.4038C92.5,-223.9125 92.5,-214.8341 92.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-205.8115 92.5,-195.8116 89.0001,-205.8116 96.0001,-205.8115"/></g><!-- 2 --><g id="node3" class="node"><title>2</title><path fill="none" stroke="#000000" d="M12,-.5C12,-.5 173,-.5 173,-.5 179,-.5 185,-6.5 185,-12.5 185,-12.5 185,-67.5 185,-67.5 185,-73.5 179,-79.5 173,-79.5 173,-79.5 12,-79.5 12,-79.5 6,-79.5 0,-73.5 0,-67.5 0,-67.5 0,-12.5 0,-12.5 0,-6.5 6,-.5 12,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-52 10.5,-73 175.5,-73 175.5,-52 10.5,-52"/><text text-anchor="start" x="88.5" y="-58.8" font-family="Courier New" font-size="14.00" fill="#000000">C</text><text text-anchor="start" x="13.5" y="-35.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x3</text><text text-anchor="start" x="13.5" y="-12.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 1&#45;&gt;2 --><g id="edge2" class="edge"><title>1&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M92.5,-116.4038C92.5,-107.9125 92.5,-98.8341 92.5,-90.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-89.8115 92.5,-79.8116 89.0001,-89.8116 96.0001,-89.8115"/></g><!-- 2&#45;&gt;2 --><g id="edge3" class="edge"><title>2&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M185.2015,-58.2426C195.9847,-54.8758 203,-48.7949 203,-40 203,-34.0909 199.8332,-29.407 194.4845,-25.9482"/><polygon fill="#0000ff" stroke="#0000ff" points="195.7559,-22.6821 185.2015,-21.7574 192.8756,-29.0621 195.7559,-22.6821"/></g></g></svg>

Good! Miasm now renders our basic blocks titles and labels using the names we expect.
Since miasm never does this automatically, we should always apply relevant names when setting up a workspace.
For example, we can apply the names of imported and exported symbols to a PE container:

```python
pe.loc_db.add_location(offset=pe.entry_point, name='entry', strict=False)

for symbol, va in miasm.jitter.loader.pe.get_export_name_addr_list(pe.executable):
    if isinstance(symbol, int):
        # ordinal
        pe.loc_db.add_location(offset=va, name=f'#{symbol}', strict=False)
    else:
        pe.loc_db.add_location(offset=va, name=symbol, strict=False)

for ((dll, symbol), addresses) in miasm.jitter.loader.pe.get_import_address_pe(pe.executable).items():
    for va in addresses:
        pe.loc_db.add_location(offset=va, name=f'{dll}!{symbol}', strict=False)
```

Returning to our shellcode example, we can query the LocationDB by offset and name:

```python
loc_db.get_offset_location(0x0)
>>> <LocKey 0>

loc_db.get_name_location('A')
>>> <LocKey 0>

loc_db.get_location_names(loc_db.get_name_location('A'))
>>> frozenset({b'A'})
```

That final line is neat to me: miasm supports assigning multiple names to the same location.
This is helpful when a function is exported many times with different names.

### Disassembling from many entry points 

We know, from prior knowledge, that our shellcode snippet has multiple entry points: `A` and `D`.
How can we get miasm to recognize both of these?
I found that the best way is to generate a CFG for each entry point and then merge the graphs together into a single, master CFG:

```python
job_done = set()
a_cfg = disassembler.dis_multiblock(loc_db.get_name_offset("A"), job_done=job_done)
d_cfg = disassembler.dis_multiblock(loc_db.get_name_offset("D"), job_done=job_done)
cfg = miasm.core.asmblock.AsmCFG(loc_db)
cfg.merge(a_cfg)
cfg.merge(d_cfg)
cfg.apply_splitting(disassembler.loc_db,
                    dis_block_callback=disassembler.dis_block_callback,
                    mn=disassembler.arch,
                    attrib=disassembler.attrib,
                    pool_bin=disassembler.bin_stream)
```

<svg width="396pt" height="320pt" viewBox="0.00 0.00 396.00 320.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 316)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-316 392,-316 392,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-232.5C12,-232.5 173,-232.5 173,-232.5 179,-232.5 185,-238.5 185,-244.5 185,-244.5 185,-299.5 185,-299.5 185,-305.5 179,-311.5 173,-311.5 173,-311.5 12,-311.5 12,-311.5 6,-311.5 0,-305.5 0,-299.5 0,-299.5 0,-244.5 0,-244.5 0,-238.5 6,-232.5 12,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-284 10.5,-305 175.5,-305 175.5,-284 10.5,-284"/><text text-anchor="start" x="88.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">A</text><text text-anchor="start" x="13.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text><text text-anchor="start" x="13.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;B</text></g><!-- 1 --><g id="node2" class="node"><title>1</title><path fill="none" stroke="#000000" d="M12,-116.5C12,-116.5 173,-116.5 173,-116.5 179,-116.5 185,-122.5 185,-128.5 185,-128.5 185,-183.5 185,-183.5 185,-189.5 179,-195.5 173,-195.5 173,-195.5 12,-195.5 12,-195.5 6,-195.5 0,-189.5 0,-183.5 0,-183.5 0,-128.5 0,-128.5 0,-122.5 6,-116.5 12,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-168 10.5,-189 175.5,-189 175.5,-168 10.5,-168"/><text text-anchor="start" x="88.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">B</text><text text-anchor="start" x="13.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 0&#45;&gt;1 --><g id="edge1" class="edge"><title>0&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M92.5,-232.4038C92.5,-223.9125 92.5,-214.8341 92.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-205.8115 92.5,-195.8116 89.0001,-205.8116 96.0001,-205.8115"/></g><!-- 2 --><g id="node3" class="node"><title>2</title><path fill="none" stroke="#000000" d="M113,-.5C113,-.5 274,-.5 274,-.5 280,-.5 286,-6.5 286,-12.5 286,-12.5 286,-67.5 286,-67.5 286,-73.5 280,-79.5 274,-79.5 274,-79.5 113,-79.5 113,-79.5 107,-79.5 101,-73.5 101,-67.5 101,-67.5 101,-12.5 101,-12.5 101,-6.5 107,-.5 113,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="111.5,-52 111.5,-73 276.5,-73 276.5,-52 111.5,-52"/><text text-anchor="start" x="189.5" y="-58.8" font-family="Courier New" font-size="14.00" fill="#000000">C</text><text text-anchor="start" x="114.5" y="-35.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x3</text><text text-anchor="start" x="114.5" y="-12.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 1&#45;&gt;2 --><g id="edge2" class="edge"><title>1&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M126.976,-116.4038C135.0925,-107.0818 143.8252,-97.0522 152.2076,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="154.9095,-89.6518 158.8365,-79.8116 149.6302,-85.0551 154.9095,-89.6518"/></g><!-- 2&#45;&gt;2 --><g id="edge3" class="edge"><title>2&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M286.2015,-58.2426C296.9847,-54.8758 304,-48.7949 304,-40 304,-34.0909 300.8332,-29.407 295.4845,-25.9482"/><polygon fill="#0000ff" stroke="#0000ff" points="296.7559,-22.6821 286.2015,-21.7574 293.8756,-29.0621 296.7559,-22.6821"/></g><!-- 3 --><g id="node4" class="node"><title>3</title><path fill="none" stroke="#000000" d="M215,-232.5C215,-232.5 376,-232.5 376,-232.5 382,-232.5 388,-238.5 388,-244.5 388,-244.5 388,-299.5 388,-299.5 388,-305.5 382,-311.5 376,-311.5 376,-311.5 215,-311.5 215,-311.5 209,-311.5 203,-305.5 203,-299.5 203,-299.5 203,-244.5 203,-244.5 203,-238.5 209,-232.5 215,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-284 213.5,-305 378.5,-305 378.5,-284 213.5,-284"/><text text-anchor="start" x="291.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">D</text><text text-anchor="start" x="216.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x4</text><text text-anchor="start" x="216.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;E</text></g><!-- 4 --><g id="node5" class="node"><title>4</title><path fill="none" stroke="#000000" d="M215,-116.5C215,-116.5 376,-116.5 376,-116.5 382,-116.5 388,-122.5 388,-128.5 388,-128.5 388,-183.5 388,-183.5 388,-189.5 382,-195.5 376,-195.5 376,-195.5 215,-195.5 215,-195.5 209,-195.5 203,-189.5 203,-183.5 203,-183.5 203,-128.5 203,-128.5 203,-122.5 209,-116.5 215,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-168 213.5,-189 378.5,-189 378.5,-168 213.5,-168"/><text text-anchor="start" x="291.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">E</text><text text-anchor="start" x="216.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x5</text><text text-anchor="start" x="216.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 3&#45;&gt;4 --><g id="edge4" class="edge"><title>3&#45;&gt;4</title><path fill="none" stroke="#0000ff" d="M295.5,-232.4038C295.5,-223.9125 295.5,-214.8341 295.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="299.0001,-205.8115 295.5,-195.8116 292.0001,-205.8116 299.0001,-205.8115"/></g><!-- 4&#45;&gt;2 --><g id="edge5" class="edge"><title>4&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M260.6827,-116.4038C252.4857,-107.0818 243.6666,-97.0522 235.2013,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="237.7385,-85.0101 228.5067,-79.8116 232.4817,-89.6325 237.7385,-85.0101"/></g></g></svg>

(In my testing, I discovered a couple ways to build a single, master CFG and that the above strategy shows the best performance.
 Please review the [Appendix](#appendix-i-miasm-disassembly-internals) for further details.)


## Conclusion

This is the second post in a series.
Next, I'll collect some thoughts on how to use miasm to identify functions and other constructs.
Maybe we'll get to emulation (still haven't attempted this yet).

When it comes to disassembly, I like how miasm is very explicit about its analysis and results.
It doesn't hide side effects within stateful objects, rather it returns the results and lets *you* decide how to merge, diff, and/or serialize them.
I can imagine building an "undo" feature when using miasm, while this would be nearly impossible in IDAPython or vivisect.

The downside, of course, is that you have to stitch together analyzers as you see fit.
I wonder if somewhere there is a repository of reusable miasm analyzers. I haven't found one yet.


## Appendix I: Miasm disassembly internals

I've shared a technique for disassembling multiple entry points and merging their control flow graphs.
For me, this construction worked the best, but it took multiple tries to get here.
Let's learn a bit more about miasm's algorithm so we can maintain performance and avoid a subtle bug.

[Here](https://github.com/cea-sec/miasm/blob/a2d2e3bd87636c2ccca1afecc5c7c20360aa43fa/miasm/core/asmblock.py#L1604-L1616)
 is the implementation of `dis_multiblock`: 

```python
    def dis_multiblock(self, offset, blocks=None, job_done=None):
        if job_done is None:
            job_done = set()
        if blocks is None:
            blocks = AsmCFG(self.loc_db)
        todo = [offset]

        while len(todo):
            ...
            target_offset = int(todo.pop(0))
            if (target_offset is None or
                    target_offset in job_done):
                continue
            cur_block, nexts = self._dis_block(target_offset, job_done)
            todo += nexts
            blocks.add_block(cur_block)
        ...
```

This is a straightforward recursive descent disassembler that uses a job queue of virtual addresses called `todo`.
Starting from the given virtual address, miasm disassembles a basic block, saves it off, and adds the successors to the queue.
It then pops a new virtual address from the queue and repeats, until the queue is empty.

To avoid looping endlessly over blocks that branch to themselves, miasm uses an index called `job_done` to track the virtual addresses of blocks it has already considered.
It skips blocks that it's already seen.
You can provide an initialized set for `job_done` to restrict the paths that miasm will disassemble.

Miasm places the collected basic blocks into the `AsmCFG` instance named blocks.
Again, you can provide an initialized instances for `blocks`, in which case miasm will merge the results together.

With this knowledge, we can create a naive solution in which we disassemble from multiple points, reusing the same `AsmCFG` instance:

```python
cfg = miasm.core.asmblock.AsmCFG(loc_db=loc_db)
disassembler.dis_multiblock(offset=loc_db.get_name_offset("A"), blocks=cfg)
disassembler.dis_multiblock(offset=loc_db.get_name_offset("D"), blocks=cfg)
```

<svg width="396pt" height="320pt" viewBox="0.00 0.00 396.00 320.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 316)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-316 392,-316 392,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-232.5C12,-232.5 173,-232.5 173,-232.5 179,-232.5 185,-238.5 185,-244.5 185,-244.5 185,-299.5 185,-299.5 185,-305.5 179,-311.5 173,-311.5 173,-311.5 12,-311.5 12,-311.5 6,-311.5 0,-305.5 0,-299.5 0,-299.5 0,-244.5 0,-244.5 0,-238.5 6,-232.5 12,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-284 10.5,-305 175.5,-305 175.5,-284 10.5,-284"/><text text-anchor="start" x="88.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">A</text><text text-anchor="start" x="13.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text><text text-anchor="start" x="13.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;B</text></g><!-- 1 --><g id="node2" class="node"><title>1</title><path fill="none" stroke="#000000" d="M12,-116.5C12,-116.5 173,-116.5 173,-116.5 179,-116.5 185,-122.5 185,-128.5 185,-128.5 185,-183.5 185,-183.5 185,-189.5 179,-195.5 173,-195.5 173,-195.5 12,-195.5 12,-195.5 6,-195.5 0,-189.5 0,-183.5 0,-183.5 0,-128.5 0,-128.5 0,-122.5 6,-116.5 12,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-168 10.5,-189 175.5,-189 175.5,-168 10.5,-168"/><text text-anchor="start" x="88.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">B</text><text text-anchor="start" x="13.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 0&#45;&gt;1 --><g id="edge1" class="edge"><title>0&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M92.5,-232.4038C92.5,-223.9125 92.5,-214.8341 92.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-205.8115 92.5,-195.8116 89.0001,-205.8116 96.0001,-205.8115"/></g><!-- 2 --><g id="node3" class="node"><title>2</title><path fill="none" stroke="#000000" d="M113,-.5C113,-.5 274,-.5 274,-.5 280,-.5 286,-6.5 286,-12.5 286,-12.5 286,-67.5 286,-67.5 286,-73.5 280,-79.5 274,-79.5 274,-79.5 113,-79.5 113,-79.5 107,-79.5 101,-73.5 101,-67.5 101,-67.5 101,-12.5 101,-12.5 101,-6.5 107,-.5 113,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="111.5,-52 111.5,-73 276.5,-73 276.5,-52 111.5,-52"/><text text-anchor="start" x="189.5" y="-58.8" font-family="Courier New" font-size="14.00" fill="#000000">C</text><text text-anchor="start" x="114.5" y="-35.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x3</text><text text-anchor="start" x="114.5" y="-12.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 1&#45;&gt;2 --><g id="edge2" class="edge"><title>1&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M126.976,-116.4038C135.0925,-107.0818 143.8252,-97.0522 152.2076,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="154.9095,-89.6518 158.8365,-79.8116 149.6302,-85.0551 154.9095,-89.6518"/></g><!-- 2&#45;&gt;2 --><g id="edge3" class="edge"><title>2&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M286.2015,-58.2426C296.9847,-54.8758 304,-48.7949 304,-40 304,-34.0909 300.8332,-29.407 295.4845,-25.9482"/><polygon fill="#0000ff" stroke="#0000ff" points="296.7559,-22.6821 286.2015,-21.7574 293.8756,-29.0621 296.7559,-22.6821"/></g><!-- 3 --><g id="node4" class="node"><title>3</title><path fill="none" stroke="#000000" d="M215,-232.5C215,-232.5 376,-232.5 376,-232.5 382,-232.5 388,-238.5 388,-244.5 388,-244.5 388,-299.5 388,-299.5 388,-305.5 382,-311.5 376,-311.5 376,-311.5 215,-311.5 215,-311.5 209,-311.5 203,-305.5 203,-299.5 203,-299.5 203,-244.5 203,-244.5 203,-238.5 209,-232.5 215,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-284 213.5,-305 378.5,-305 378.5,-284 213.5,-284"/><text text-anchor="start" x="291.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">D</text><text text-anchor="start" x="216.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x4</text><text text-anchor="start" x="216.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;E</text></g><!-- 4 --><g id="node5" class="node"><title>4</title><path fill="none" stroke="#000000" d="M215,-116.5C215,-116.5 376,-116.5 376,-116.5 382,-116.5 388,-122.5 388,-128.5 388,-128.5 388,-183.5 388,-183.5 388,-189.5 382,-195.5 376,-195.5 376,-195.5 215,-195.5 215,-195.5 209,-195.5 203,-189.5 203,-183.5 203,-183.5 203,-128.5 203,-128.5 203,-122.5 209,-116.5 215,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-168 213.5,-189 378.5,-189 378.5,-168 213.5,-168"/><text text-anchor="start" x="291.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">E</text><text text-anchor="start" x="216.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x5</text><text text-anchor="start" x="216.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 3&#45;&gt;4 --><g id="edge4" class="edge"><title>3&#45;&gt;4</title><path fill="none" stroke="#0000ff" d="M295.5,-232.4038C295.5,-223.9125 295.5,-214.8341 295.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="299.0001,-205.8115 295.5,-195.8116 292.0001,-205.8116 299.0001,-205.8115"/></g><!-- 4&#45;&gt;2 --><g id="edge5" class="edge"><title>4&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M260.6827,-116.4038C252.4857,-107.0818 243.6666,-97.0522 235.2013,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="237.7385,-85.0101 228.5067,-79.8116 232.4817,-89.6325 237.7385,-85.0101"/></g></g></svg>

That graph looks great! It has all the basic blocks that we expect.
It works by disassembling from each entry point, and having miasm place the results into the same mutable `AsmCFG` instance.

However, there are two issues with this naive solution:

  1. the performance is sub-optimal, because `job_done` is not maintained across calls.
  2. there's unexpected O(n<sup>2</sup>) runtime thanks to internal basic block bookkeeping.

### `job_done`

First, miasm does too much work because we're not providing a shared `job_done` index to `dis_multiblock`.
Instead, the local variable get reinitialized on each call, so miasm forgets which blocks it has already processed and repeats work - wasting our time.

In our example, we call `dis_multiblock` twice, for entry points `A` and `D`.
Miasm will disassemble blocks `A`, `B`, and then `C` during the first invocation, then `D`, `E`, and then `C` (again!).
The work for `C` (and any blocks that flow from it) is done twice.
While our example is simple, and `C` is trivial to disassemble, `C` may be extremely complex in the real world.
[We might be left wondering why miasm seems slow at analysis](https://blog.quarkslab.com/an-experimental-study-of-different-binary-exporters.html).

Therefore, we should tweak our solution to share an instance of `job_done` across calls to `dis_multiblock`:

```python
cfg = miasm.core.asmblock.AsmCFG(loc_db=loc_db)
job_done = set()
disassembler.dis_multiblock(offset=loc_db.get_name_offset("A"), job_done=job_done, blocks=cfg)
disassembler.dis_multiblock(offset=loc_db.get_name_offset("D"), job_done=job_done, blocks=cfg)
```

And the results are exactly the same:

<svg width="396pt" height="320pt" viewBox="0.00 0.00 396.00 320.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 316)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-316 392,-316 392,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-232.5C12,-232.5 173,-232.5 173,-232.5 179,-232.5 185,-238.5 185,-244.5 185,-244.5 185,-299.5 185,-299.5 185,-305.5 179,-311.5 173,-311.5 173,-311.5 12,-311.5 12,-311.5 6,-311.5 0,-305.5 0,-299.5 0,-299.5 0,-244.5 0,-244.5 0,-238.5 6,-232.5 12,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-284 10.5,-305 175.5,-305 175.5,-284 10.5,-284"/><text text-anchor="start" x="88.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">A</text><text text-anchor="start" x="13.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text><text text-anchor="start" x="13.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;B</text></g><!-- 1 --><g id="node2" class="node"><title>1</title><path fill="none" stroke="#000000" d="M12,-116.5C12,-116.5 173,-116.5 173,-116.5 179,-116.5 185,-122.5 185,-128.5 185,-128.5 185,-183.5 185,-183.5 185,-189.5 179,-195.5 173,-195.5 173,-195.5 12,-195.5 12,-195.5 6,-195.5 0,-189.5 0,-183.5 0,-183.5 0,-128.5 0,-128.5 0,-122.5 6,-116.5 12,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-168 10.5,-189 175.5,-189 175.5,-168 10.5,-168"/><text text-anchor="start" x="88.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">B</text><text text-anchor="start" x="13.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 0&#45;&gt;1 --><g id="edge1" class="edge"><title>0&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M92.5,-232.4038C92.5,-223.9125 92.5,-214.8341 92.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-205.8115 92.5,-195.8116 89.0001,-205.8116 96.0001,-205.8115"/></g><!-- 2 --><g id="node3" class="node"><title>2</title><path fill="none" stroke="#000000" d="M113,-.5C113,-.5 274,-.5 274,-.5 280,-.5 286,-6.5 286,-12.5 286,-12.5 286,-67.5 286,-67.5 286,-73.5 280,-79.5 274,-79.5 274,-79.5 113,-79.5 113,-79.5 107,-79.5 101,-73.5 101,-67.5 101,-67.5 101,-12.5 101,-12.5 101,-6.5 107,-.5 113,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="111.5,-52 111.5,-73 276.5,-73 276.5,-52 111.5,-52"/><text text-anchor="start" x="189.5" y="-58.8" font-family="Courier New" font-size="14.00" fill="#000000">C</text><text text-anchor="start" x="114.5" y="-35.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x3</text><text text-anchor="start" x="114.5" y="-12.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 1&#45;&gt;2 --><g id="edge2" class="edge"><title>1&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M126.976,-116.4038C135.0925,-107.0818 143.8252,-97.0522 152.2076,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="154.9095,-89.6518 158.8365,-79.8116 149.6302,-85.0551 154.9095,-89.6518"/></g><!-- 2&#45;&gt;2 --><g id="edge3" class="edge"><title>2&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M286.2015,-58.2426C296.9847,-54.8758 304,-48.7949 304,-40 304,-34.0909 300.8332,-29.407 295.4845,-25.9482"/><polygon fill="#0000ff" stroke="#0000ff" points="296.7559,-22.6821 286.2015,-21.7574 293.8756,-29.0621 296.7559,-22.6821"/></g><!-- 3 --><g id="node4" class="node"><title>3</title><path fill="none" stroke="#000000" d="M215,-232.5C215,-232.5 376,-232.5 376,-232.5 382,-232.5 388,-238.5 388,-244.5 388,-244.5 388,-299.5 388,-299.5 388,-305.5 382,-311.5 376,-311.5 376,-311.5 215,-311.5 215,-311.5 209,-311.5 203,-305.5 203,-299.5 203,-299.5 203,-244.5 203,-244.5 203,-238.5 209,-232.5 215,-232.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-284 213.5,-305 378.5,-305 378.5,-284 213.5,-284"/><text text-anchor="start" x="291.5" y="-290.8" font-family="Courier New" font-size="14.00" fill="#000000">D</text><text text-anchor="start" x="216.5" y="-267.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x4</text><text text-anchor="start" x="216.5" y="-244.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;E</text></g><!-- 4 --><g id="node5" class="node"><title>4</title><path fill="none" stroke="#000000" d="M215,-116.5C215,-116.5 376,-116.5 376,-116.5 382,-116.5 388,-122.5 388,-128.5 388,-128.5 388,-183.5 388,-183.5 388,-189.5 382,-195.5 376,-195.5 376,-195.5 215,-195.5 215,-195.5 209,-195.5 203,-189.5 203,-183.5 203,-183.5 203,-128.5 203,-128.5 203,-122.5 209,-116.5 215,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="213.5,-168 213.5,-189 378.5,-189 378.5,-168 213.5,-168"/><text text-anchor="start" x="291.5" y="-174.8" font-family="Courier New" font-size="14.00" fill="#000000">E</text><text text-anchor="start" x="216.5" y="-151.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x5</text><text text-anchor="start" x="216.5" y="-128.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;C</text></g><!-- 3&#45;&gt;4 --><g id="edge4" class="edge"><title>3&#45;&gt;4</title><path fill="none" stroke="#0000ff" d="M295.5,-232.4038C295.5,-223.9125 295.5,-214.8341 295.5,-206.0074"/><polygon fill="#0000ff" stroke="#0000ff" points="299.0001,-205.8115 295.5,-195.8116 292.0001,-205.8116 299.0001,-205.8115"/></g><!-- 4&#45;&gt;2 --><g id="edge5" class="edge"><title>4&#45;&gt;2</title><path fill="none" stroke="#0000ff" d="M260.6827,-116.4038C252.4857,-107.0818 243.6666,-97.0522 235.2013,-87.425"/><polygon fill="#0000ff" stroke="#0000ff" points="237.7385,-85.0101 228.5067,-79.8116 232.4817,-89.6325 237.7385,-85.0101"/></g></g></svg>

### Block splitting

However, I found that this solution still showed very poor performance when analyzing real programs.
The culprit is that miasm [invokes a routine](https://github.com/cea-sec/miasm/blob/a2d2e3bd87636c2ccca1afecc5c7c20360aa43fa/miasm/core/asmblock.py#L1618)
 called `apply_splitting` at the tail of `dis_multiblock`, whose purpose is to split basic blocks that have a jump target in the middle of them.

For example, consider the assembly snippet:

```assembly
A:
mov eax, 1
B:
mov eax, 2
jmp B
```

Before splitting, miasm incorrectly computes the following CFG, which groups all instructions into a single basic block:

<svg width="193pt" height="111pt" viewBox="0.00 0.00 193.00 111.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 107)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-107 189,-107 189,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-.5C12,-.5 173,-.5 173,-.5 179,-.5 185,-6.5 185,-12.5 185,-12.5 185,-90.5 185,-90.5 185,-96.5 179,-102.5 173,-102.5 173,-102.5 12,-102.5 12,-102.5 6,-102.5 0,-96.5 0,-90.5 0,-90.5 0,-12.5 0,-12.5 0,-6.5 6,-.5 12,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-75.5 10.5,-96.5 175.5,-96.5 175.5,-75.5 10.5,-75.5"/><text text-anchor="start" x="88.5" y="-82.3" font-family="Courier New" font-size="14.00" fill="#000000">A</text><text text-anchor="start" x="13.5" y="-59.3" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text><text text-anchor="start" x="13.5" y="-36.3" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-13.3" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;B</text></g></g></svg>

After splitting, miasm correctly recovers the CFG, splitting `A` to account for the jump target `B`:

<svg width="211pt" height="181pt" viewBox="0.00 0.00 211.00 181.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 177)"><title>asm_graph</title><polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-177 207,-177 207,4 -4,4"/><!-- 0 --><g id="node1" class="node"><title>0</title><path fill="none" stroke="#000000" d="M12,-116.5C12,-116.5 173,-116.5 173,-116.5 179,-116.5 185,-122.5 185,-128.5 185,-128.5 185,-160.5 185,-160.5 185,-166.5 179,-172.5 173,-172.5 173,-172.5 12,-172.5 12,-172.5 6,-172.5 0,-166.5 0,-160.5 0,-160.5 0,-128.5 0,-128.5 0,-122.5 6,-116.5 12,-116.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-145.5 10.5,-166.5 175.5,-166.5 175.5,-145.5 10.5,-145.5"/><text text-anchor="start" x="88.5" y="-152.3" font-family="Courier New" font-size="14.00" fill="#000000">A</text><text text-anchor="start" x="13.5" y="-129.3" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x1</text></g><!-- 1 --><g id="node2" class="node"><title>1</title><path fill="none" stroke="#000000" d="M12,-.5C12,-.5 173,-.5 173,-.5 179,-.5 185,-6.5 185,-12.5 185,-12.5 185,-67.5 185,-67.5 185,-73.5 179,-79.5 173,-79.5 173,-79.5 12,-79.5 12,-79.5 6,-79.5 0,-73.5 0,-67.5 0,-67.5 0,-12.5 0,-12.5 0,-6.5 6,-.5 12,-.5"/><polygon fill="#c0c0c0" stroke="transparent" points="10.5,-52 10.5,-73 175.5,-73 175.5,-52 10.5,-52"/><text text-anchor="start" x="88.5" y="-58.8" font-family="Courier New" font-size="14.00" fill="#000000">B</text><text text-anchor="start" x="13.5" y="-35.8" font-family="Courier New" font-size="14.00" fill="#000000">MOV &#160;&#160;&#160;&#160;&#160;&#160;&#160;EAX, 0x2</text><text text-anchor="start" x="13.5" y="-12.8" font-family="Courier New" font-size="14.00" fill="#000000">JMP &#160;&#160;&#160;&#160;&#160;&#160;&#160;B</text></g><!-- 0&#45;&gt;1 --><g id="edge2" class="edge"><title>0&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M92.5,-116.4959C92.5,-108.3257 92.5,-99.1391 92.5,-90.042"/><polygon fill="#0000ff" stroke="#0000ff" points="96.0001,-89.868 92.5,-79.868 89.0001,-89.868 96.0001,-89.868"/></g><!-- 1&#45;&gt;1 --><g id="edge1" class="edge"><title>1&#45;&gt;1</title><path fill="none" stroke="#0000ff" d="M185.2015,-56.6424C195.9847,-53.5709 203,-48.0234 203,-40 203,-34.6093 199.8332,-30.3362 194.4845,-27.1809"/><polygon fill="#0000ff" stroke="#0000ff" points="195.7808,-23.9296 185.2015,-23.3576 193.1151,-30.4022 195.7808,-23.9296"/></g></g></svg>

This behavior is good; however, there is trouble in the way `dis_multiblock` interacts with `apply_splitting`.
Every time `apply_splitting` is invoked, miasm 
 [checks](https://github.com/cea-sec/miasm/blob/a2d2e3bd87636c2ccca1afecc5c7c20360aa43fa/miasm/core/asmblock.py#L786-L810)
 all basic blocks in the CFG:

```python
    def apply_splitting(self, loc_db, dis_block_callback=None, **kwargs):
        ...
        todo = set(self.blocks)

        while todo:
            cur_block = todo.pop()
```

If we use the same `AsmCFG` in across multiple calls to `dis_multiblock`, then we repeatedly process the same blocks many times.
While it may look innocuous, when disassembling `kernel32.dll` with its 2000 exports, miasm spends most of its time re-re-re-checking blocks for splits.
The runtime performance is O(n<sup>2</sup>).

The trick is to create a separate CFG for each entry point and merge them at the end (also using the `job_done` trick, too).
This way, each basic block is checked for splitting just once, and runtime performance is back to O(n).

```python
job_done = set()
a_cfg = disassembler.dis_multiblock(loc_db.get_name_offset("A"), job_done=job_done)
d_cfg = disassembler.dis_multiblock(loc_db.get_name_offset("D"), job_done=job_done)
cfg = miasm.core.asmblock.AsmCFG(loc_db)
cfg.merge(a_cfg)
cfg.merge(d_cfg)
cfg.apply_splitting(disassembler.loc_db,
                    dis_block_callback=disassembler.dis_block_callback,
                    mn=disassembler.arch,
                    attrib=disassembler.attrib,
                    pool_bin=disassembler.bin_stream)
```

The code is a little ugly, but its easily wrapped in a function.
For me, this brought the runtime of disassembling 100 exports from `kernel32.dll` down from 90 seconds to 3 seconds!


Wrapping everything together, here's the utility function I've been using recently:


```python
def disassemble_all(container, entries):
    mdis = machine.dis_engine(container.bin_stream, loc_db=container.loc_db, follow_call=True)
    
    job_done = set()
    cfgs = {}

    for va in entries:
        cfgs[va] = mdis.dis_multiblock(va, job_done=job_done)

    blocks = miasm.core.asmblock.AsmCFG(container.loc_db)
    for cfg in cfgs.values():
        blocks.merge(cfg)

    blocks.apply_splitting(container.loc_db,
                           dis_block_callback=mdis.dis_block_callback,
                           mn=mdis.arch,
                           attrib=mdis.attrib,
                           pool_bin=mdis.bin_stream)
    return blocks


entries = [pe.entry_point]
entries.extend([va for symbol, va in miasm.jitter.loader.pe.get_export_name_addr_list(pe.executable)])
cfg = disassemble_all(pe, entries)
```
